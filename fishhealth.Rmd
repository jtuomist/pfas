---
title: "Fish and health with national fish promotion programme: model run and results"
author: "Jouni Tuomisto"
date: "07 03 2021"
output: html_document
params:
  N: 200
  porvoo: FALSE
---
## Shortcut to model download

This is an open assessment looking at potential health effects of a national fish promotion program in Finland. The details of the assessment are described at [Opasnet](http://fi.opasnet.org/fi/PFAS-yhdisteiden tautitaakka). This file contains the R code to run the assessment model.

This code downloads all the ovariables created by the previous code, fishhealth_initiate.Rmd, runs the model and plots various graphs and tables about the results.

Fix these problems:

2. Calculate total personal BoD for individuals in Porvoo and Vanhankaupunginlahti. Do not compare those at the (Finnish) population level.
3. Correct the fish intake distribution to manage dimension Fishing correctly.
4. Check that all oapply NA-fillings are intended.
5. Correct the "Kalansyönti Suomessa keskimäärin" figure.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) 

library(OpasnetUtils) # Install the newest version from https://github.com/jtuomist/OpasnetUtils not from CRAN.
library(tidyverse)
library(plotly)
library(readxl)
library(reshape2)

openv.setN(params$N)

trim <- function(ova) {
  if("Exposcen" %in% colnames(ova)) ova <- ova[ova$Exposcen=="BAU",]
  ova <- oapply(ova,NULL,mean,"Iter")@output
  return(ova)
}

```


```{r modelrun}

objects.latest("Op_fi5932",code_name="initiate") # [[PFAS-yhdisteiden tautitaakka]]

if(!params$porvoo) {
  Decconc@dectable <- Decconc@dectable[Decconc@dectable$Option=="BAU",]
}

conc_eukalat <- EvalOutput(conc_eukalat)
BoDattr <- EvalOutput(BoDattr, verbose=TRUE)

```

```{r summary tables}

oprint(summary(amount,"mean"))
oprint(summary(BoD,marginals=c("Age","Response"),"mean"))
oprint(summary(BoD,marginals=c("Gender","Response"),"mean"))
oprint(summary(BoDattr,marginals=c("Age","Response"),"mean"))
oprint(summary(BoDattr,marginals=c("Exposure_agent","Response"),"mean"))
oprint(summary(BoDattr,marginals=c("Gender","Response"),"mean"))
oprint(summary(case_burden,"mean"))
oprint(summary(conc,"mean"))
oprint(summary(dose,"mean"))
oprint(summary(ERF,"mean"))
oprint(summary(expo_dir,"mean"))
oprint(summary(expo_dir,marginals="Exposure_agent"))
oprint(summary(expo_indir,"mean"))
oprint(summary(exposure,"mean"))
#oprint(summary(fish_proportion,"mean"))
oprint(summary(incidence,"mean"))
oprint(summary(PAF,"mean"))
oprint(summary(population,"mean"))
oprint(summary(RR,"mean"))


```


```{r plots}
###################
# Graphs
tmp <- trim(amount)
tmp <- tmp[tmp$Fishing!="Vanhankaupunginlahti",]
tmp$Group <- factor(tmp$Group, levels=c("Infants","Toddlers","Other children","Adolescents",
                                        "Adults", "Elderly"))

p <- ggplot(tmp, aes(x=Group, weight=amountResult, fill=Fish))+geom_bar()+
  coord_flip()+
  labs(
    title="Kalansyönti Suomessa ikäryhmittäin",
    y="Syönti (g/d)"
  )
  if(params$porvoo) {
    p <- p + facet_grid(Fishing ~ Gender)
    print(p)
    ggsave("Kalansyönti Suomessa ja Porvoossa ikäryhmittäin.svg")
  } else {
    p <- p + facet_grid(Gender~ .)
    print(p)
    ggsave("Kalansyönti Suomessa ikäryhmittäin.svg")
  }

tmp <- oapply(amount,NULL,sum,"Fish")@output
head(tmp)
p <- ggplot(tmp, aes(x=amountResult+1, colour=Group))+stat_ecdf()+
  scale_x_log10()+
  coord_cartesian(xlim=c(3,300))+
  labs(
    title="Kalansyönti väestössä",
    x="Kalansyönti (g päivässä)",
    y="Kumulatiivinen todennäköisyysjakauma"
  )
if(params$porvoo) p <- p + facet_grid(Fishing~.)
p
ggsave("Kalansyönnin jakauma Suomessa.svg")

plot_ly(trim(EvalOutput(total_amount)), x=~Kala, y=~total_amountResult, color=~Kala, type="bar") %>%
  layout(yaxis=list(title="Kalan kokonaiskulutus Suomessa (milj kg /a)"), barmode="stack")

ggplot(conc_mehg@output, aes(x=conc_mehgResult, colour=Area))+stat_ecdf()+
  scale_x_log10()+facet_wrap(~Fish, scales="free_x")

ggplot(trim(conc_pfas), aes(x=Fish, y=conc_pfasResult))+geom_point()+ # Inputed data for missing species.
  coord_flip()

ggplot(conc_pfas@output, aes(x=conc_pfasResult, color=Compound, linetype=Area))+stat_ecdf()+
  scale_x_log10()+
  stat_ecdf(data=conc_eukalat@output, aes(x=conc_eukalatResult))+
  scale_linetype_manual(values=c("dotted","solid","twodash"))+
  labs(
    title="PFAS concentration in fish in Finland",
    x="PFAS concentration (ng/g fresh weight)",
    y="Cumulative probability"
  )
# The code may produce some negative values, which are removed from the graph
ggsave("PFAS-pitoisuus kalassa Suomessa.svg")

ggplot(conc@output, aes(x=concResult, colour=Fish))+stat_ecdf()+
  facet_wrap(~Compound, scales="free_x")

limits <- data.frame(
  Exposure_agent = c("TEQ","MeHg","PFAS","Vitamin D"),
  Type = c("TDI","TDI","TDI","RDI"),
  Result = c(2*70/7, 1.3*70/7,4.4*70/7,10)
)

tmp <- EvalOutput(expo_dir, verbose=TRUE) # Calculated again because we want Group, which is collapsed
tmp <- oapply(tmp,NULL,sum,c("Fish","fish_proportionSource","amountSource","concSource"))
tmp <- oapply(tmp,NULL,mean,"Scaling")
tmp <- tmp[tmp$Exposcen=="BAU" & !tmp$Exposure_agent %in% c("ALA", "EPA") ,]
tmp$Group <- factor(tmp$Group, levels=c("Toddlers","Other children","Adolescents","Adults","Elderly"))
if(params$porvoo) {
  tmp <- tmp[tmp$Exposure_agent=="PFAS",] 
  limits <- limits[limits$Exposure_agent=="PFAS",]
  titl <- "PFAS-yhdisteiden saanti kalasta eri ryhmissä"
} else titl <- "Yhdisteiden saanti kalasta"
p <- ggplot(tmp@output, aes(x=expo_dirResult+0.5, colour=Group))+stat_ecdf()+
  scale_x_log10()+
  geom_vline(data=limits, aes(xintercept=Result, linetype=Type))+
  geom_point(data = oapply(tmp,c("Group","Exposure_agent","Fishing"),mean)@output,
             aes(x=expo_dirResult, y=0.1), shape=1, size=3, stroke=2)+
  labs(title=titl,
       x="Suora altistuminen päivässä (kala: g, rasvahapot: mg, D-vit: ug, PFAS: ng, TEQ: pg)",
       y="kumulatiivinen todennäköisyys")
if(params$porvoo) {
  p <- p + facet_grid(Fishing ~ .)
  print(p)
  ggsave("PFAS-yhdisteiden saanti kalasta Suomessa ja Porvoossa.svg")
} else {
  p <- p + facet_wrap(~Exposure_agent, scales="free_x")
  print(p)
  ggsave("Yhdisteiden saanti kalasta Suomessa.svg")
}

ggplot(trim(oapply(exposure,NULL,mean,"Gender")), aes(x=Age, weight=exposureResult))+geom_bar()+
  facet_wrap(~Exposure_agent, scales="free_y")+
  labs(
    title="Exposure to compounds",
    y="(omega: mg/d; vit D: ug/d, PFAS: ng/d)"
  )

cat("Kalaperäisiä tautitaakkoja Suomessa\n")

if(openv$N>1) {
  tmp <- summary(ERF)
  tmp <- data.frame(
    Altiste = tmp$Exposure_agent,
    Vaikutus = tmp$Response,
    Annosvastefunktio = tmp$ER_function,
    Skaalaus = tmp$Scaling,
    Havainto = tmp$Observation,
    Keskiarvo = as.character(signif(tmp$mean,2)),
    "95 luottamusväli" = paste0(signif(tmp$Q0.025,2)," - ", signif(tmp$Q0.975,2)),
    Keskihajonta = signif(tmp$sd,2)
  )#[rev(match(lev, tmp$Exposure_agent)),]

  oprint(tmp)
  
  tmp <- summary(oapply(BoDattr,NULL,sum,c("Age","Gender","Response")))
  tmp <- data.frame(
    Altiste = tmp$Exposure_agent,
    Alue = tmp$Fishing,
    Keskiarvo = as.character(signif(tmp$mean,2)),
    "95 luottamusväli" = paste0(signif(tmp$Q0.025,2)," - ", signif(tmp$Q0.975,2)),
    Keskihajonta = signif(tmp$sd,2)
  )#[rev(match(lev, tmp$Exposure_agent)),]

  oprint(tmp)
  
  tmp <- summary(oapply(BoDattr,NULL,sum,c("Age","Gender","Exposure_agent")))
  tmp <- data.frame(
    Terveysvaikutus = tmp$Response,
    Alue = tmp$Fishing,
    Keskiarvo = signif(tmp$mean,2),
    "95 luottamusväli" = paste0(signif(tmp$Q0.025,2)," - ", signif(tmp$Q0.975,2)),
    Keskihajonta = signif(tmp$sd,2)
  )
  oprint(tmp)

  tmp <- summary(oapply(BoDattr,NULL,sum,c("Age","Gender","Exposure_agent","Response")))
  tmp <- data.frame(
    Terveysvaikutus = "Yhteensä",
    Alue = tmp$Fishing,
    Keskiarvo = signif(tmp$mean,2),
    "95 luottamusväli" = paste0(signif(tmp$Q0.025,2)," - ", signif(tmp$Q0.975,2)),
    Keskihajonta = signif(tmp$sd,2)
  )
  oprint(tmp)
}

tmp <- trim(BoDattr[BoDattr$Fishing=="BAU",])
ggplot(tmp, aes(x=Exposure_agent, weight=BoDattrResult, fill=Response))+geom_bar()+
  labs(
    title="Tautitaakka kalasta tekijöittäin",
    x="Kalassa oleva tekijä",
    y="Tautitaakka (DALY/a"
  )
ggsave("Tautitaakka kalasta tekijöittäin.svg")

ggplot(tmp, aes(x=Age, weight=BoDattrResult, fill=Response))+geom_bar(position="stack")+
  scale_x_discrete(breaks = levels(ages)[seq(1,length(ages),3)])+
  labs(
    title="Tautitaakka kalassa olevista tekijöistä",
    x="Ikäryhmä",
    y="Tautitaakka (DALY/a)"
  )
ggsave("Tautitaakka kalassa olevista tekijöistä.svg")

tmp <- trim(BoDattr / population * 1000)
p <- ggplot(tmp, aes(x=Age, weight=Result, fill=Response))+geom_bar(position="stack")+
  scale_x_discrete(breaks = levels(ages)[seq(1,length(ages),3)])+
  labs(
    title="Tautitaakka kalassa olevista tekijöistä per henkilö",
    x="Ikäryhmä",
    y="Tautitaakka (mDALY/hlö/a)"
  )
if(params$porvoo) {
  p <- p + facet_wrap(~Fishing)
  oprint(p)
  ggsave("Tautitaakka kalassa olevista tekijöistä per henkilö.svg")
}

################ Insight network
#gr <- scrape(type="assessment")
#objects.latest("Op_en3861", "makeGraph") # [[Insight network]]
#gr <- makeGraph(gr)
#export_graph(gr, "ruori.svg")
#render_graph(gr) # Does not work: Error in generate_dot(graph) : object 'attribute' not found
##################### Diagnostics
#objects.latest("Op_en6007", code_name="diagnostics")
#print(showLoctable())
#print(showind())

```

```{r finale}
# Run all above
```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
